<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Realtime Chat (çµ±åˆç‰ˆ)</title>
<style>
body { font-family: sans-serif; margin:20px; background:#0f1223; color:#e8edf0; }
h2 { margin-top:0; }
input, select, button { margin:5px; padding:8px; border-radius:6px; }
button { cursor:pointer; }
#chatBox { border:1px solid #334169; height:300px; overflow-y:auto; padding:8px; margin:10px 0; background:#121632; }
.msg { margin:6px 0; padding:6px; border-radius:6px; background:#1a1f3b; }
.meta { font-size:12px; color:#94a3b8; }
</style>
</head>
<body>
<h1>Realtime Chat (çµ±åˆç‰ˆ)</h1>

<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<button onclick="showSection('admin')">éƒ¨å±‹ä½œæˆ</button>
<button onclick="showSection('chat')">ãƒãƒ£ãƒƒãƒˆå‚åŠ </button>

<!-- Admin: éƒ¨å±‹ä½œæˆ -->
<section id="admin" style="display:block;">
  <h2>éƒ¨å±‹ä½œæˆ</h2>
  <label>éƒ¨å±‹å: <input type="text" id="roomName"></label><br>
  <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: <input type="password" id="roomPass"></label><br>
  <button onclick="createRoom()">ä½œæˆ</button>
  <p id="adminInfo"></p>
</section>

<!-- Chat: å‚åŠ ï¼†ãƒãƒ£ãƒƒãƒˆ -->
<section id="chat" style="display:none;">
  <h2>ãƒãƒ£ãƒƒãƒˆå‚åŠ </h2>
  <label>éƒ¨å±‹: <select id="roomSelect"></select></label><br>
  <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: <input type="password" id="joinPass"></label><br>
  <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ : <input type="text" id="nickname"></label><br>
  <button onclick="joinRoom()">å‚åŠ </button>
  <p id="joinInfo"></p>

  <div id="chatArea" style="display:none;">
    <h3 id="roomTitle"></h3>
    <div id="chatBox"></div>
    <input type="text" id="msg" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
    <button onclick="sendMsg()">é€ä¿¡</button>
  </div>
</section>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
/* ğŸ”‘ Firebaseæ§‹æˆæƒ…å ±ã‚’å¿…ãšå·®ã—æ›¿ãˆã¦ãã ã•ã„ */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
const $ = id => document.getElementById(id);
async function sha256(text){
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
function showSection(id){
  $("admin").style.display = (id==="admin")?"block":"none";
  $("chat").style.display = (id==="chat")?"block":"none";
  if(id==="chat") loadRooms();
}

/* éƒ¨å±‹ä½œæˆ */
async function createRoom(){
  const name = $("roomName").value.trim();
  const pass = $("roomPass").value;
  if(!name || !pass){ $("adminInfo").textContent="å…¥åŠ›ã—ã¦ãã ã•ã„"; return; }
  const passHash = await sha256(pass);
  await db.ref("rooms/"+name).set({ passHash, createdAt: Date.now() });
  $("adminInfo").textContent = "éƒ¨å±‹ã€Œ"+name+"ã€ã‚’ä½œæˆã—ã¾ã—ãŸã€‚";
  $("roomName").value=""; $("roomPass").value="";
}

/* éƒ¨å±‹ä¸€è¦§èª­ã¿è¾¼ã¿ */
async function loadRooms(){
  const snap = await db.ref("rooms").get();
  const rooms = snap.val()||{};
  $("roomSelect").innerHTML = Object.keys(rooms).map(r=>`<option value="${r}">${r}</option>`).join("");
}

/* å‚åŠ  */
let currentRoom=null, nickname=null;
async function joinRoom(){
  const room = $("roomSelect").value;
  const pass = $("joinPass").value;
  nickname = $("nickname").value.trim();
  if(!room || !pass || !nickname){ $("joinInfo").textContent="å…¥åŠ›ä¸è¶³"; return; }
  const snap = await db.ref("rooms/"+room).get();
  if(!snap.exists()){ $("joinInfo").textContent="éƒ¨å±‹ãŒå­˜åœ¨ã—ã¾ã›ã‚“"; return; }
  const passHash = await sha256(pass);
  if(snap.val().passHash!==passHash){ $("joinInfo").textContent="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"; return; }
  currentRoom=room;
  $("roomTitle").textContent="éƒ¨å±‹: "+room;
  $("chatArea").style.display="block";
  subscribeMessages(room);
}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ */
function sendMsg(){
  const text=$("msg").value.trim();
  if(!text) return;
  db.ref("messages/"+currentRoom).push({nick:nickname,text,ts:Date.now()});
  $("msg").value="";
}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è³¼èª­ */
function subscribeMessages(room){
  db.ref("messages/"+room).limitToLast(100).on("value",snap=>{
    const data=snap.val()||{};
    const list=Object.values(data).sort((a,b)=>a.ts-b.ts);
    $("chatBox").innerHTML=list.map(m=>{
      const time=new Date(m.ts).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
      return `<div class="msg"><div class="meta">${m.nick} (${time})</div><div>${escapeHtml(m.text)}</div></div>`;
    }).join("");
    $("chatBox").scrollTop=$("chatBox").scrollHeight;
  });
}
function escapeHtml(s){ return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>
</body>
</html>
